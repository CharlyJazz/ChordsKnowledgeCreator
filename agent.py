from anthropic import Anthropic
import os
import json
from dotenv import load_dotenv

load_dotenv('./.env')

client = Anthropic(
    api_key=os.environ.get("ANTHROPIC_API_KEY")
)

class AgentChordKnowledgeCreator:
    @staticmethod
    def get_chords(chord: str) -> dict:
        output = client.messages.create(
            model="claude-3-7-sonnet-20250219",
            max_tokens=20000,
            temperature=1,
            system="You need and you must ALWAYS return the JSON Format that I requested and the theorical whole information under \"details\"\n\nYou are a highly knowledgeable music theory expert with extensive experience in classical, jazz, and contemporary music. Your task is to analyze a given chord item, provide a simplified chord name if possible, and identify related scales. \n\nHere is the chord item you need to analyze:\n\n<chord_item>\n{{CHORD_ITEM}}\n</chord_item>\n\nPlease follow these instructions carefully:\n\n1. Analyze the chord item thoroughly, considering all its musical properties, including its structure, extensions, alterations, and tonal implications.\n\n2. Based on your analysis, determine if there's a simpler or more commonly used name for this chord that still accurately represents its harmonic content. This simplified name should be a well-known synonym or an equivalent chord name that musicians would recognize. If no simpler name exists, state that the original name is the most appropriate.\n\n3. Identify scales that are closely related to this chord. For each related scale, provide:\n   a. The scale name\n   b. Any alternative names for the scale\n   c. Musical genres commonly associated with this scale\n   d. The scale's intervals using standard interval syntax\n   e. An explanation of how this scale relates to the given chord and how it can be used in the context of this specific chord\n\n4. Before providing your final output, save that analysis inside the property \"chord_analysis\". This should include:\n   a. A detailed breakdown of the chord's structure and components\n   b. Your reasoning for the simplified name (if applicable)\n   c. The process for identifying related scales\n   d. An explanation of how each scale relates to the chord\n\n5. Your final output should be in JSON format, including all original attributes of the chord item plus the additional information requested (chord analysis, simplified name, and related scales). Ensure that the JSON is properly formatted and includes all the information from your analysis.\n\nHere's an example of how your output structure should look (note that this is a generic structure and your actual output should be more detailed and specific to the given chord):\n\n{\n  \"original_chord_name\": \"[Original chord name]\",\n  \"chord_analysis\": \"[Detailed analysis of the chord's properties]\",\n  \"simplified_name\": \"[Simplified chord name or statement that original is most appropriate]\",\n  \"related_scales\": [\n    {\n      \"name\": \"[Scale name]\",\n      \"alternative_names\": [\"[Alt name 1]\", \"[Alt name 2]\"],\n      \"genres\": [\"[Genre 1]\", \"[Genre 2]\"],\n      \"intervals\": \"[Scale intervals in standard syntax]\",\n      \"usage\": \"[How this scale relates to and can be used with the given chord]\",\n       \"midiNotes\": [Notes midis for scale to sounds in AudioKit under a soundfont2 file]\n    },\n    {\n      // Additional scales as needed\n    }\n  ],\n  // Include all other original attributes from the chord item\n}\n\nRemember to include all original attributes from the chord item in your final JSON output, along with the new information you've generated through your analysis.\n\nInformation:\n\n# Music Theory Summaries: Chord Notation, Jazz Chords, Universal Key, and Tablature\n\n## Chord Notation\n**Chord notation** refers to the system of names and symbols used to represent musical chords, especially in popular music contexts such as jazz, pop, and rock. Instead of writing all notes on a staff, musicians use abbreviations (letters, numbers, and symbols) to indicate which chord to play. A chord symbol typically conveys several aspects:\n\n- **Root note**: the base note of the chord, indicated with a letter (e.g., *C* for C, *F♯* for F sharp).\n- **Chord quality (type)**: whether the chord is major, minor, augmented, diminished, etc. By convention, major chords often omit any symbol (assumed major), while *m* indicates minor, **+** for augmented, **°** (or *dim*) for diminished.\n- **Extensions or variants**: indicates whether the chord is a basic triad, seventh chord, or has added tensions (9th, 11th, etc.). For example, **Δ7** means a major seventh chord.\n- **Note alterations**: modifications using sharps or flats, e.g., **♯5** for an augmented fifth.\n- **Added notes**: extra notes not implied by the basic chord, such as **add9**.\n- **Slash chords (alternate bass)**: if the lowest note (bass) is not the root. For example, **C/E** means a C major chord with E in the bass.\n\nA complex chord like **Caug7** (C augmented seventh) breaks down as **C** (root), **aug** (augmented fifth, G♯), and **7** (minor seventh, B♭), forming the notes C–E–G♯–B♭.\n\nChord notation is used universally in jazz and popular music for harmonic charts, fake books, or lead sheets. For example, a standard C major progression might be written as: **C – Am – Dm – G7**. Jazz players may freely add 7ths or 9ths even when not written, whereas pop/rock players typically stick to basic triads unless otherwise indicated.\n\n**Alternative notation systems** include:\n- **Staff notation**\n- **Roman numeral analysis** (for classical theory)\n- **Figured bass** (Baroque)\n- **Numerical notation** (used in some cultures)\n- **Nashville Number System** (country music), using Arabic numerals to indicate scale degrees\n\n## Jazz Chords\nA **jazz chord** is any chord (and its symbol) commonly used in jazz harmony. Jazz chords are usually richer than basic triads, often including 7ths, 9ths, 11ths, and 13ths—even if not explicitly notated.\n\n- **Added extensions**: Jazz chords often include added *tensions* like 7ths, 9ths, 11ths, or 13ths.\n- **Omission of root and fifth**: Comping players often omit the root (and sometimes the fifth) since the bassist usually plays the root.\n- **Voicing focus**: The 3rd and 7th define the chord quality and are prioritized. Voicings are constructed around them, with added tensions.\n- **Altered tensions**: Jazz musicians may alter tensions (e.g., ♭9, ♯11) to create more color and harmonic interest. For example, **G7(♭9♯11)** might be voiced as G–B–F–A♭–C♯.\n\nJazz players use chord symbols as guides rather than strict instructions, allowing creative interpretation and reharmonization while maintaining harmonic function.\n\n## Universal Key\nThe **universal key** (or *universal scale*) is a theoretical system in which notes or chords are represented by **numbers** or **Roman numerals**, making relationships transferable to any key. For example, in E♭ major:\n\n- E♭ = 1\n- F = 2\n- G = 3\n- A♭ = 4\n- B♭ = 5\n- C = 6\n- D = 7\n\nIn classical theory, **Roman numerals** represent the function of each chord:\n- Uppercase = major quality (e.g., **I**, **IV**, **V**)\n- Lowercase = minor or diminished (e.g., **ii**, **vii°**)\n\nExample with 7th chords in E♭ major:\n- **I** = E♭ major\n- **ii⁷** = F minor 7\n- **iii⁷** = G minor 7\n- **IVmaj⁷** = A♭ major 7\n- **V⁷** = B♭7\n- **vi⁷** = C minor 7\n- **viiø⁷** = D half-diminished 7\n\nIn jazz/pop, numerals are often written with chord symbols for clarity:\n**Imaj7, IIm7, IIIm7, IVmaj7, V7, VIm7, VIIø7**\n\nFor non-diatonic chords, **accidentals** are added to the degree:\n- ♭IIImaj7 = flat third degree\n- ♯IV = sharp fourth degree\n\nThis system allows easy transposition and analysis. For example, a progression like I–vi–IV–V is the same in any key.\n\n## Tablature\n**Tablature** (or *tab*) is a form of musical notation that indicates **instrument fingering** rather than pitch. It is common for **fretted string instruments** like guitar, bass, lute, and vihuela, and is also used for harmonica.\n\nRather than standard staff notation, tablature shows **strings as lines** and **fret numbers** as numbers on those lines. For guitar:\n- Six horizontal lines represent strings (e B G D A E)\n- A number on a line = fret to press\n- 0 = play open string\n\nIf a **capo** is used, fret numbers are relative to the capo position.\n\nChord names often appear above the tab to indicate harmony. For example:\n```\ne|---0---1---3---\nB|---0---1---0---\nG|---1---2---0---\nD|---2---3---0---\nA|---2---3---2---\nE|---0---1---3---\n     E   F   G\n```\n\nSpecial symbols indicate performance techniques:\n- **h** = hammer-on\n- **p** = pull-off\n- **b** = bend\n- **/** = slide up\n- **\\\\** = slide down\n- **v** = vibrato\n\nTablature is common in modern teaching materials, songbooks, and websites for genres like rock, pop, and folk, making it an essential notation system for contemporary guitarists.\n\n\n\n\nEverything in your response needs to be JSON VALID Parseable.".replace("\n", "").replace("\t", "").replace("    ", "").replace("{{CHORD_ITEM}}", chord.lower()),
            messages=[
                {
                    "role": "user",
                    "content": [
                        {
                            "type": "text",
                            "text": "<examples>\n<example>\n<CHORD_ITEM>\nmaj11add13\n</CHORD_ITEM>\n<ideal_output>\n{\n  \"name\": \"maj13#11\",\n  \"intervals\": {\n    \"third\": 4,\n    \"fifth\": 7,\n    \"seventh\": 11,\n    \"additions\": [\n      14,\n      18,\n      21\n    ]\n  },\n  \"chordPopularName\": \"Major Thirteenth Sharp Eleven\",\n  \"description\": \"A major thirteenth chord with a sharpened eleventh interval. Creates a very lush, modern jazz sound with a touch of dissonance. Popular in fusion, contemporary jazz, and sophisticated pop.\",\n  \"funFact\": \"Used extensively by pianists like Herbie Hancock and Chick Corea to create complex yet beautiful harmonies.\",\n  \"difficulty_level\": \"difficult\",\n  \"difficulty_explanation\": \"Very complex chord requiring advanced understanding of altered extensions and voice leading.\",\n  \"original_chord_name\": \"maj13#11\",\n  \"chord_analysis\": \"This chord represents a fully extended major chord with a major 7th (11 semitones), 9th (14 semitones), #11th (18 semitones), and 13th (21 semitones). The core structure is a major 7th chord (1-3-5-7) with all upper extensions added. The #11 (or #4) creates a characteristic Lydian sound that gives this chord a bright, open quality despite its complexity. The 13th extension adds warmth and fullness to the bottom of the sound. Each extension serves a specific purpose: the major 7th establishes the chord quality, the 9th adds color, the #11 adds tension and a distinctive character, and the 13th rounds out the harmony with a warm top note.\",\n  \"simplified_name\": \"Lydian maj13 or maj13(#11)\",\n  \"related_scales\": [\n    {\n      \"name\": \"Lydian Scale\",\n      \"alternative_names\": [\"Major #4 Scale\", \"Fourth Mode of Major Scale\"],\n      \"genres\": [\"Jazz\", \"Fusion\", \"Progressive Rock\", \"Film Scoring\", \"New Age\"],\n      \"intervals\": \"1 2 3 #4 5 6 7\",\n      \"usage\": \"The Lydian scale is the primary scale choice for this chord, as it naturally contains the #11 that defines the chord's distinctive sound. This scale perfectly accommodates all chord tones (1, 3, 5, 7, 9, #11, 13) without any clashes. The raised 4th degree creates a bright, floating quality that complements the extended major harmony. When improvising over this chord, the Lydian scale allows for emphasizing the #11 as a color tone while maintaining the chord's fundamental major quality.\",\n      \"midiNotes\": [60, 62, 64, 66, 67, 69, 71]\n    },\n    {\n      \"name\": \"Lydian Dominant Scale\",\n      \"alternative_names\": [\"Overtone Scale\", \"Acoustic Scale\", \"Fourth Mode of Melodic Minor\"],\n      \"genres\": [\"Jazz Fusion\", \"Contemporary Jazz\", \"Film Music\", \"Progressive Music\"],\n      \"intervals\": \"1 2 3 #4 5 6 b7\",\n      \"usage\": \"While this scale contains a b7 rather than the major 7th in the chord, it can be used as a passing or tension scale over the maj13#11 chord for a more bluesy or fusion-oriented sound. The #11 is preserved, which maintains the Lydian character. This scale works particularly well when the harmony is in transition or when a more bluesy color is desired despite the major 7th in the chord structure.\",\n      \"midiNotes\": [60, 62, 64, 66, 67, 69, 70]\n    },\n    {\n      \"name\": \"Major Bebop Scale\",\n      \"alternative_names\": [\"Bebop Major Scale\"],\n      \"genres\": [\"Jazz\", \"Bebop\", \"Mainstream Jazz\"],\n      \"intervals\": \"1 2 3 4 5 #5 6 7\",\n      \"usage\": \"This eight-note scale adds a chromatic passing tone (#5) between the 5th and 6th degrees. While it doesn't naturally contain the #11, jazz musicians might replace or alternate the natural 4 with the #11 when playing over this chord. The scale's advantage is its rhythmic smoothness when played in eighth notes, making it suitable for bop-style lines over complex harmonies like the maj13#11 chord.\",\n      \"midiNotes\": [60, 62, 64, 65, 67, 68, 69, 71]\n    },\n    {\n      \"name\": \"Lydian Augmented Scale\",\n      \"alternative_names\": [\"Third Mode of Melodic Minor\"],\n      \"genres\": [\"Modern Jazz\", \"Contemporary Classical\", \"Avant-garde Jazz\"],\n      \"intervals\": \"1 2 3 #4 #5 6 7\",\n      \"usage\": \"This scale contains both the crucial #11 and an augmented 5th, offering additional color possibilities. Although the chord doesn't specify an augmented 5th, this scale can provide a more exotic sound palette that still accommodates the chord's essential character. The #5 can function as a tension note or passing tone, particularly effective in more contemporary or experimental musical contexts.\",\n      \"midiNotes\": [60, 62, 64, 66, 68, 69, 71]\n    }\n  ]\n}\n</ideal_output>\n</example>\n<example>\n<CHORD_ITEM>\n[C13, C7, CAUG, Cadd9sus4b5]\n</CHORD_ITEM>\n<ideal_output>\n{\n    \"chords\": [\n        {\n            \"original_chord_name\": \"C13\",\n            \"intervals\": {\n                \"root\": 0,\n                \"third\": 4,\n                \"fifth\": 7,\n                \"seventh\": 10,\n                \"ninth\": 14,\n                \"eleventh\": 17,\n                \"thirteenth\": 21\n            },\n            \"chord_analysis\": \"A dominant 13th chord built on C, featuring a full extended harmony. Includes the basic major triad (C-E-G), minor seventh (Bb), ninth (D), eleventh (F), and thirteenth (A). This chord provides a rich, complex harmonic texture typical in jazz and contemporary music, with multiple tension points and a characteristic dominant sound.\",\n            \"simplified_name\": \"Dominant 13th Chord\",\n            \"related_scales\": [\n                {\n                    \"name\": \"Mixolydian Scale\",\n                    \"alternative_names\": [\"Dominant Scale\"],\n                    \"genres\": [\"Jazz\", \"Blues\", \"Rock\", \"Funk\"],\n                    \"intervals\": \"1 2 3 4 5 6 b7\",\n                    \"usage\": \"Canonical scale for improvising over dominant chords. Perfectly contains all notes of the C13 chord, providing a natural melodic foundation for improvisational lines.\",\n                    \"midiNotes\": [60, 62, 64, 65, 67, 69, 70]\n                }\n            ]\n        },\n        {\n            \"original_chord_name\": \"C7\",\n            \"intervals\": {\n                \"root\": 0,\n                \"third\": 4,\n                \"fifth\": 7,\n                \"seventh\": 10\n            },\n            \"chord_analysis\": \"A dominant seventh chord built on C, consisting of a major triad with a lowered (minor) seventh. This chord creates tension and a strong pull towards resolution, fundamental in blues, jazz, and Western classical harmony. The flatted seventh introduces a characteristic dissonance that demands harmonic movement.\",\n            \"simplified_name\": \"Dominant Seventh Chord\",\n            \"related_scales\": [\n                {\n                    \"name\": \"Mixolydian Scale\",\n                    \"alternative_names\": [\"Dominant Scale\"],\n                    \"genres\": [\"Jazz\", \"Blues\", \"Rock\"],\n                    \"intervals\": \"1 2 3 4 5 6 b7\",\n                    \"usage\": \"Perfectly matches the C7 chord, providing a natural melodic framework for improvisation and harmonic exploration.\",\n                    \"midiNotes\": [60, 62, 64, 65, 67, 69, 70]\n                }\n            ]\n        },\n        {\n            \"original_chord_name\": \"CAUG\",\n            \"intervals\": {\n                \"root\": 0,\n                \"third\": 4,\n                \"fifth\": 8\n            },\n            \"chord_analysis\": \"An augmented triad built on C, characterized by a major third and an augmented fifth. This symmetrical chord creates a sense of tension and ambiguity, with no clear tonal center. Often used for dramatic harmonic effects, transitional passages, and creating unique coloristic moments in modern and experimental music.\",\n            \"simplified_name\": \"Augmented Triad\",\n            \"related_scales\": [\n                {\n                    \"name\": \"Whole Tone Scale\",\n                    \"alternative_names\": [\"Augmented Scale\"],\n                    \"genres\": [\"Impressionist Music\", \"Modern Jazz\", \"Contemporary Classical\"],\n                    \"intervals\": \"1 2 3 #4 #5 #6\",\n                    \"usage\": \"Perfectly complements the augmented chord, sharing its symmetrical and ambiguous harmonic nature. Provides a natural melodic environment for the CAUG chord.\",\n                    \"midiNotes\": [60, 62, 64, 66, 68, 70]\n                }\n            ]\n        },\n        {\n            \"original_chord_name\": \"CADD9sus4b5\",\n            \"intervals\": {\n                \"root\": 0,\n                \"fourth\": 5,\n                \"fifth\": 6,\n                \"ninth\": 14\n            },\n            \"chord_analysis\": \"A highly complex and experimental chord that combines multiple alterations. Suspended fourth replaces the third, diminished fifth alters the standard fifth, and an added ninth provides additional color. This chord represents an extreme example of harmonic exploration, challenging traditional chord construction and offering unique textural possibilities.\",\n            \"simplified_name\": \"Altered Suspended Chord with Added Ninth\",\n            \"related_scales\": [\n                {\n                    \"name\": \"Altered Scale\",\n                    \"alternative_names\": [\"Altered Dominant Scale\"],\n                    \"genres\": [\"Modern Jazz\", \"Avant-Garde\", \"Experimental Music\"],\n                    \"intervals\": \"1 b2 #2 3 #4 #5 b7\",\n                    \"usage\": \"Provides a complex harmonic palette that matches the experimental nature of the CADD9sus4b5 chord, allowing for extreme chromatic and tension-filled improvisations.\",\n                    \"midiNotes\": [60, 61, 63, 64, 66, 68, 70]\n                }\n            ]\n        }\n    ]\n}\n</ideal_output>\n</example>\n</examples>\n\n"
                        },
                        {
                            "type": "text",
                            "text": f"CHORD_ITEM Will be equal to {chord.lower()}"
                        }
                    ]
                }
            ]
        )
        clean_json_string = output.content[0].text.replace("json", "").replace("\n", "").replace("```", "")
        return json.loads(clean_json_string) 